// koffee 1.4.0
var Action, Bullet, Item, Material, Timer, _,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

_ = require('kxk')._;

Item = require('./item');

Action = require('./action');

Timer = require('./timer');

Material = require('./material');

Bullet = (function(superClass) {
    extend(Bullet, superClass);

    function Bullet() {
        this.size = 0.2;
        this.shooter = null;
        Bullet.__super__.constructor.apply(this, arguments);
        this.addAction(new Action(this, Action.FLY, 'fly', 40));
        this.addAction(new Action(this, Action.EXPLODE, 'explode', 200));
    }

    Bullet.prototype.del = function() {
        if (this.mesh != null) {
            this.mesh.geometry.dispose();
            this.mesh.material.dispose();
            world.scene.remove(this.mesh);
            Timer.removeActionsOfObject(this);
            _.pull(world.objects, this);
            return this.mesh = null;
        }
    };

    Bullet.prototype.createMesh = function() {
        var geom;
        geom = new THREE.SphereGeometry(1, 16, 16);
        this.mesh = new THREE.Mesh(geom, Material.bullet.clone());
        return this.mesh.scale.set(this.size, this.size, this.size);
    };

    Bullet.shootFromBot = function(bot) {
        var bullet;
        bullet = new Bullet();
        world.addObject(bullet);
        bullet.direction = bot.currentDir();
        bullet.setPosition(bot.position.plus(bullet.direction.mul(0.8)));
        bullet.shooter = bot;
        bullet.mesh.material.color.set(bot.mesh.material.color);
        world.playSound('BULLET_SHOT', bot.getPos());
        if (bullet.hitObjectAtPos(bot.position.plus(bullet.direction))) {
            return;
        }
        return Timer.addAction(bullet.getActionWithId(Action.FLY));
    };

    Bullet.prototype.performAction = function(action) {
        var ref, relTime;
        relTime = action.getRelativeTime();
        if (action.id === Action.FLY) {
            return this.current_position = this.position.plus(this.direction.mul(relTime));
        } else if (action.id === Action.EXPLODE) {
            this.size = 0.2 + relTime / 2.0;
            return (ref = this.mesh) != null ? ref.material.opacity = 0.8 * (1.0 - relTime) : void 0;
        }
    };

    Bullet.prototype.step = function() {
        this.mesh.position.copy(this.current_position);
        return this.mesh.scale.set(this.size, this.size, this.size);
    };

    Bullet.prototype.hitObjectAtPos = function(pos) {
        var hitObject, ref, ref1;
        if ((ref = world.switchAtPos(pos)) != null) {
            ref.bulletImpact();
        }
        if (world.isInvalidPos(pos) || world.isOccupiedPos(pos)) {
            hitObject = world.getRealOccupantAtPos(pos);
            if (hitObject !== this.shooter) {
                if (hitObject != null) {
                    hitObject.bulletImpact();
                    world.playSound((ref1 = typeof hitObject.bulletHitSound === "function" ? hitObject.bulletHitSound() : void 0) != null ? ref1 : 'BULLET_HIT_OBJECT');
                } else {
                    world.playSound('BULLET_HIT_WALL', pos);
                }
                Timer.addAction(this.getActionWithId(Action.EXPLODE));
                return true;
            }
        }
        return false;
    };

    Bullet.prototype.finishAction = function(action) {
        if (action.name === "fly") {
            return this.position = this.current_position;
        }
    };

    Bullet.prototype.actionFinished = function(action) {
        if (action.id === Action.FLY) {
            if (this.hitObjectAtPos(this.position.plus(this.direction.mul(0.5)))) {
                return;
            }
            return Timer.addAction(this.getActionWithId(Action.FLY));
        } else if (action.id === Action.EXPLODE) {
            return this.del();
        }
    };

    return Bullet;

})(Item);

module.exports = Bullet;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsbGV0LmpzIiwic291cmNlUm9vdCI6Ii4iLCJzb3VyY2VzIjpbIiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBTUEsSUFBQSx3Q0FBQTtJQUFBOzs7QUFBRSxJQUFNLE9BQUEsQ0FBUSxLQUFSOztBQUNSLElBQUEsR0FBVyxPQUFBLENBQVEsUUFBUjs7QUFDWCxNQUFBLEdBQVcsT0FBQSxDQUFRLFVBQVI7O0FBQ1gsS0FBQSxHQUFXLE9BQUEsQ0FBUSxTQUFSOztBQUNYLFFBQUEsR0FBVyxPQUFBLENBQVEsWUFBUjs7QUFFTDs7O0lBRUMsZ0JBQUE7UUFDQyxJQUFDLENBQUEsSUFBRCxHQUFRO1FBQ1IsSUFBQyxDQUFBLE9BQUQsR0FBVztRQUNYLHlDQUFBLFNBQUE7UUFDQSxJQUFDLENBQUEsU0FBRCxDQUFXLElBQUksTUFBSixDQUFXLElBQVgsRUFBYyxNQUFNLENBQUMsR0FBckIsRUFBOEIsS0FBOUIsRUFBd0MsRUFBeEMsQ0FBWDtRQUNBLElBQUMsQ0FBQSxTQUFELENBQVcsSUFBSSxNQUFKLENBQVcsSUFBWCxFQUFjLE1BQU0sQ0FBQyxPQUFyQixFQUE4QixTQUE5QixFQUF3QyxHQUF4QyxDQUFYO0lBTEQ7O3FCQU9ILEdBQUEsR0FBSyxTQUFBO1FBRUQsSUFBRyxpQkFBSDtZQUNJLElBQUMsQ0FBQSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQWYsQ0FBQTtZQUNBLElBQUMsQ0FBQSxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQWYsQ0FBQTtZQUNBLEtBQUssQ0FBQyxLQUFLLENBQUMsTUFBWixDQUFtQixJQUFDLENBQUEsSUFBcEI7WUFDQSxLQUFLLENBQUMscUJBQU4sQ0FBNEIsSUFBNUI7WUFDQSxDQUFDLENBQUMsSUFBRixDQUFPLEtBQUssQ0FBQyxPQUFiLEVBQXNCLElBQXRCO21CQUNBLElBQUMsQ0FBQSxJQUFELEdBQVEsS0FOWjs7SUFGQzs7cUJBVUwsVUFBQSxHQUFZLFNBQUE7QUFFUixZQUFBO1FBQUEsSUFBQSxHQUFPLElBQUksS0FBSyxD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TixDQUFnQixpQkFBaEIsRUFBa0MsR0FBbEMsRUFKSjs7Z0JBS0EsS0FBSyxDQUFDLFNBQU4sQ0FBZ0IsSUFBQyxDQUFBLGVBQUQsQ0FBaUIsTUFBTSxDQUFDLE9BQXhCLENBQWhCO0FBQ0EsdUJBQU8sS0FQWDthQUZKOztlQVVBO0lBZFk7O3FCQWdCaEIsWUFBQSxHQUFjLFNBQUMsTUFBRDtRQUFZLElBQWlDLE1BQU0sQ0FBQyxJQUFQLEtBQWUsS0FBaEQ7bUJBQUEsSUFBQyxDQUFBLFFBQUQsR0FBWSxJQUFDLENBQUEsaUJBQWI7O0lBQVo7O3FCQUVkLGNBQUEsR0FBZ0IsU0FBQyxNQUFEO1FBQ1osSUFBRyxNQUFNLENBQUMsRUFBUCxLQUFhLE1BQU0sQ0FBQyxHQUF2QjtZQUNJLElBQUcsSUFBQyxDQUFBLGNBQUQsQ0FBZ0IsSUFBQyxDQUFBLFFBQVEsQ0FBQyxJQUFWLENBQWUsSUFBQyxDQUFBLFNBQVMsQ0FBQyxHQUFYLENBQWUsR0FBZixDQUFmLENBQWhCLENBQUg7QUFDSSx1QkFESjs7bUJBRUEsS0FBSyxDQUFDLFNBQU4sQ0FBZ0IsSUFBQyxDQUFBLGVBQUQsQ0FBaUIsTUFBTSxDQUFDLEdBQXhCLENBQWhCLEVBSEo7U0FBQSxNQUlLLElBQUcsTUFBTSxDQUFDLEVBQVAsS0FBYSxNQUFNLENBQUMsT0FBdkI7bUJBQ0QsSUFBQyxDQUFBLEdBQUQsQ0FBQSxFQURDOztJQUxPOzs7O0dBdkVDOztBQStFckIsTUFBTSxDQUFDLE9BQVAsR0FBaUIiLCJzb3VyY2VzQ29udGVudCI6WyIjIDAwMDAwMDAgICAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgICAgICAwMDAwMDAwMCAgMDAwMDAwMDAwXG4jIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgICAgICAwMDAgICAgICAgICAgMDAwICAgXG4jIDAwMDAwMDAgICAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgICAgICAwMDAwMDAwICAgICAgMDAwICAgXG4jIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgICAgICAwMDAgICAgICAgICAgMDAwICAgXG4jIDAwMDAwMDAgICAgIDAwMDAwMDAgICAwMDAwMDAwICAwMDAwMDAwICAwMDAwMDAwMCAgICAgMDAwICAgXG5cbnsgXyB9ID0gcmVxdWlyZSAna3hrJ1xuSXRlbSAgICAgPSByZXF1aXJlICcuL2l0ZW0nXG5BY3Rpb24gICA9IHJlcXVpcmUgJy4vYWN0aW9uJ1xuVGltZXIgICAgPSByZXF1aXJlICcuL3RpbWVyJ1xuTWF0ZXJpYWwgPSByZXF1aXJlICcuL21hdGVyaWFsJ1xuXG5jbGFzcyBCdWxsZXQgZXh0ZW5kcyBJdGVtXG4gICAgXG4gICAgQDogLT5cbiAgICAgICAgQHNpemUgPSAwLjJcbiAgICAgICAgQHNob290ZXIgPSBudWxsXG4gICAgICAgIHN1cGVyXG4gICAgICAgIEBhZGRBY3Rpb24gbmV3IEFjdGlvbiBALCBBY3Rpb24uRkxZLCAgICAgJ2ZseScgICAgIDQwXG4gICAgICAgIEBhZGRBY3Rpb24gbmV3IEFjdGlvbiBALCBBY3Rpb24uRVhQTE9ERSwgJ2V4cGxvZGUnIDIwMFxuICAgICAgICBcbiAgICBkZWw6IC0+XG4gICAgICAgIFxuICAgICAgICBpZiBAbWVzaD9cbiAgICAgICAgICAgIEBtZXNoLmdlb21ldHJ5LmRpc3Bvc2UoKVxuICAgICAgICAgICAgQG1lc2gubWF0ZXJpYWwuZGlzcG9zZSgpXG4gICAgICAgICAgICB3b3JsZC5zY2VuZS5yZW1vdmUgQG1lc2hcbiAgICAgICAgICAgIFRpbWVyLnJlbW92ZUFjdGlvbnNPZk9iamVjdCBAXG4gICAgICAgICAgICBfLnB1bGwgd29ybGQub2JqZWN0cywgQFxuICAgICAgICAgICAgQG1lc2ggPSBudWxsXG5cbiAgICBjcmVhdGVNZXNoOiAtPlxuICAgICAgICBcbiAgICAgICAgZ2VvbSA9IG5ldyBUSFJFRS5TcGhlcmVHZW9tZXRyeSAxLCAxNiwgMTZcbiAgICAgICAgQG1lc2ggPSBuZXcgVEhSRUUuTWVzaCBnZW9tLCBNYXRlcmlhbC5idWxsZXQuY2xvbmUoKVxuICAgICAgICBAbWVzaC5zY2FsZS5zZXQgQHNpemUsIEBzaXplLCBAc2l6ZVxuICAgICAgICAgICAgXG4gICAgQHNob290RnJvbUJvdDogKGJvdCkgLT5cbiAgICAgICAgXG4gICAgICAgIGJ1bGxldCA9IG5ldyBCdWxsZXQoKVxuICAgICAgICB3b3JsZC5hZGRPYmplY3QgYnVsbGV0IFxuICAgICAgICBidWxsZXQuZGlyZWN0aW9uID0gYm90LmN1cnJlbnREaXIoKVxuICAgICAgICBidWxsZXQuc2V0UG9zaXRpb24gYm90LnBvc2l0aW9uLnBsdXMgYnVsbGV0LmRpcmVjdGlvbi5tdWwgMC44XG4gICAgICAgIGJ1bGxldC5zaG9vdGVyID0gYm90XG4gICAgICAgIGJ1bGxldC5tZXNoLm1hdGVyaWFsLmNvbG9yLnNldCBib3QubWVzaC5tYXRlcmlhbC5jb2xvclxuICAgICAgICB3b3JsZC5wbGF5U291bmQgJ0JVTExFVF9TSE9UJyBib3QuZ2V0UG9zKClcbiAgICBcbiAgICAgICAgcmV0dXJuIGlmIGJ1bGxldC5oaXRPYmplY3RBdFBvcyBib3QucG9zaXRpb24ucGx1cyBidWxsZXQuZGlyZWN0aW9uXG4gICAgXG4gICAgICAgIFRpbWVyLmFkZEFjdGlvbiBidWxsZXQuZ2V0QWN0aW9uV2l0aElkIEFjdGlvbi5GTFkgXG4gICAgXG4gICAgcGVyZm9ybUFjdGlvbjogKGFjdGlvbikgLT5cbiAgICAgICAgXG4gICAgICAgIHJlbFRpbWUgPSBhY3Rpb24uZ2V0UmVsYXRpdmVUaW1lKCkgICAgICAgIFxuICAgICAgICBpZiBhY3Rpb24uaWQgPT0gQWN0aW9uLkZMWVxuICAgICAgICAgICAgQGN1cnJlbnRfcG9zaXRpb24gPSBAcG9zaXRpb24ucGx1cyBAZGlyZWN0aW9uLm11bCByZWxUaW1lXG4gICAgICAgIGVsc2UgaWYgYWN0aW9uLmlkID09IEFjdGlvbi5FWFBMT0RFXG4gICAgICAgICAgICBAc2l6ZSA9IDAuMiArIHJlbFRpbWUvMi4wXG4gICAgICAgICAgICBAbWVzaD8ubWF0ZXJpYWwub3BhY2l0eSA9IDAuOCAqICgxLjAtcmVsVGltZSlcbiAgICBcbiAgICBzdGVwOiAtPiBcbiAgICAgICAgXG4gICAgICAgIEBtZXNoLnBvc2l0aW9uLmNvcHkgQGN1cnJlbnRfcG9zaXRpb25cbiAgICAgICAgQG1lc2guc2NhbGUuc2V0IEBzaXplLCBAc2l6ZSwgQHNpemVcbiAgICBcbiAgICBoaXRPYmplY3RBdFBvczogKHBvcykgLT5cbiAgICAgICAgXG4gICAgICAgIHdvcmxkLnN3aXRjaEF0UG9zKHBvcyk/LmJ1bGxldEltcGFjdCgpXG4gICAgICAgICAgICBcbiAgICAgICAgaWYgd29ybGQuaXNJbnZhbGlkUG9zKHBvcykgb3Igd29ybGQuaXNPY2N1cGllZFBvcyBwb3MgXG4gICAgICAgICAgICBoaXRPYmplY3QgPSB3b3JsZC5nZXRSZWFsT2NjdXBhbnRBdFBvcyBwb3MgXG4gICAgICAgICAgICBpZiBoaXRPYmplY3QgIT0gQHNob290ZXJcbiAgICAgICAgICAgICAgICBpZiBoaXRPYmplY3Q/XG4gICAgICAgICAgICAgICAgICAgIGhpdE9iamVjdC5idWxsZXRJbXBhY3QoKVxuICAgICAgICAgICAgICAgICAgICB3b3JsZC5wbGF5U291bmQgaGl0T2JqZWN0LmJ1bGxldEhpdFNvdW5kPygpID8gJ0JVTExFVF9ISVRfT0JKRUNUJ1xuICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAgd29ybGQucGxheVNvdW5kICdCVUxMRVRfSElUX1dBTEwnIHBvc1xuICAgICAgICAgICAgICAgIFRpbWVyLmFkZEFjdGlvbiBAZ2V0QWN0aW9uV2l0aElkIEFjdGlvbi5FWFBMT0RFXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgICAgZmFsc2VcbiAgICBcbiAgICBmaW5pc2hBY3Rpb246IChhY3Rpb24pIC0+IEBwb3NpdGlvbiA9IEBjdXJyZW50X3Bvc2l0aW9uIGlmIGFjdGlvbi5uYW1lID09IFwiZmx5XCJcbiAgICBcbiAgICBhY3Rpb25GaW5pc2hlZDogKGFjdGlvbikgLT5cbiAgICAgICAgaWYgYWN0aW9uLmlkID09IEFjdGlvbi5GTFlcbiAgICAgICAgICAgIGlmIEBoaXRPYmplY3RBdFBvcyBAcG9zaXRpb24ucGx1cyBAZGlyZWN0aW9uLm11bCAwLjVcbiAgICAgICAgICAgICAgICByZXR1cm5cbiAgICAgICAgICAgIFRpbWVyLmFkZEFjdGlvbiBAZ2V0QWN0aW9uV2l0aElkIEFjdGlvbi5GTFlcbiAgICAgICAgZWxzZSBpZiBhY3Rpb24uaWQgPT0gQWN0aW9uLkVYUExPREVcbiAgICAgICAgICAgIEBkZWwoKVxuICAgICAgICAgICAgXG5tb2R1bGUuZXhwb3J0cyA9IEJ1bGxldFxuIl19
//# sourceURL=../coffee/bullet.coffee