// koffee 1.4.0
var Camera, Matrix, Quaternion, Vector, clamp, log,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

clamp = require('./tools/tools').clamp;

log = require('./tools/log');

Matrix = require('./lib/matrix');

Vector = require('./lib/vector');

Quaternion = require('./lib/quaternion');

Camera = (function(superClass) {
    extend(Camera, superClass);

    Camera.INSIDE = 0;

    Camera.BEHIND = 1;

    Camera.FOLLOW = 2;

    function Camera(player, opt) {
        var ref, ref1, ref2, ref3;
        this.player = player;
        this.fov = (ref = opt != null ? opt.fov : void 0) != null ? ref : 90;
        this.near = (ref1 = opt != null ? opt.near : void 0) != null ? ref1 : 0.01;
        this.eye_distance = this.near;
        this.far = (ref2 = opt != null ? opt.far : void 0) != null ? ref2 : 30;
        this.mode = Camera.BEHIND;
        this.aspect = (ref3 = opt.aspect) != null ? ref3 : -1;
        this.dist = 10;
        this.border = [0, 0, 0, 0];
        Camera.__super__.constructor.apply(this, arguments);
        this.setViewport(0.0, 0.0, 1.0, 1.0);
        this.cam = new THREE.PerspectiveCamera(this.fov, this.aspect, this.near, this.far);
        this.cam.position.z = this.dist;
    }

    Camera.prototype.step = function(step) {
        var camPos, pos;
        switch (this.mode) {
            case Camera.INSIDE:
                this.insideProjection();
                break;
            case Camera.BEHIND:
                this.behindProjection();
                break;
            case Camera.FOLLOW:
                this.followProjection();
        }
        camPos = this.getPosition();
        this.cam.position.copy(camPos);
        this.cam.up.copy(this.getYVector());
        this.cam.lookAt(camPos.plus(this.getZVector()));
        if (this.light != null) {
            pos = this.getPosition().plus(this.light_offset);
            this.light.setDirection(-this.getZVector());
            return this.light.setPosition(new Vector(pos[X], pos[Y], pos[Z], 1.0));
        }
    };

    Camera.prototype.getLookAtPosition = function() {
        return this.getZVector().mul(-this.eye_distance).plus(this.getPosition());
    };

    Camera.prototype.setOrientation = function(o) {
        this.setYVector(o.rotate(Vector.unitY));
        this.setZVector(o.rotate(Vector.unitZ));
        this.setXVector(o.rotate(Vector.minusX));
        this.cam.up.copy(this.getYVector());
        return this.cam.lookAt(this.getPosition().plus(this.getZVector()));
    };

    Camera.prototype.updateViewport = function() {};

    Camera.prototype.setViewportBorder = function(l, b, r, t) {};

    Camera.prototype.setViewport = function(l, b, w, h) {};

    Camera.prototype.setFov = function(fov) {
        return this.fov = Math.max(2.0, Math.min(fov, 175.0));
    };

    Camera.prototype.insideProjection = function() {
        var camPos, lookAngle, lookDelta, newLookVector, playerDir, playerPos, playerUp, posDelta, rot;
        playerPos = this.player.currentPos();
        playerDir = this.player.currentDir();
        playerUp = this.player.currentUp();
        lookAngle = this.player.look_angle;
        posDelta = world.getSpeed() / 10.0;
        camPos = playerPos;
        if (lookAngle < 0) {
            camPos.add(playerUp.mul(-2 * lookAngle / 90));
        }
        this.setPosition(this.getPosition().mul(1.0 - posDelta).plus(camPos.mul(posDelta)));
        if (lookAngle) {
            this.setXVector(playerDir.cross(playerUp).normal());
            rot = Quaternion.rotationAroundVector(lookAngle, this.getXVector());
            this.setYVector(rot.rotate(playerUp));
            this.setZVector(rot.rotate(playerDir));
        } else {
            lookDelta = (2.0 - this.getZVector().dot(playerDir)) * world.getSpeed() / 50.0;
            newLookVector = this.getZVector().mul(1.0 - lookDelta).plus(playerDir.mul(lookDelta));
            newLookVector.normalize();
            this.setXVector(playerUp.cross(newLookVector).normal());
            this.setYVector(playerUp);
            this.setZVector(newLookVector);
        }
        return this.projection;
    };

    Camera.prototype.behindProjection = function() {
        var botToCamera, camPos, lookAngle, lookDelta, min_f, newLookVector, playerDir, playerPos, playerUp, posDelta, rot;
        playerPos = this.player.currentPos();
        playerDir = this.player.currentDir();
        playerUp = this.player.currentUp();
        lookAngle = this.player.look_angle;
        botToCamera = playerUp.minus(playerDir.mul(2));
        min_f = botToCamera.length();
        botToCamera.normalize();
        min_f = Math.min(world.getWallDistanceForRay(playerPos, botToCamera), min_f);
        camPos = playerPos.plus(botToCamera.mul(Math.max(min_f, 0.72) * (1 - Math.abs(lookAngle) / 90)));
        if (lookAngle < 0) {
            camPos.add(playerUp.mul(-2 * lookAngle / 90));
        }
        camPos = world.getInsideWallPosWithDelta(camPos, 0.2);
        posDelta = 0.2;
        this.setPosition(this.getPosition().mul(1.0 - posDelta).plus(camPos.mul(posDelta)));
        if (lookAngle) {
            this.setXVector(playerDir.cross(playerUp).normal());
            rot = Quaternion.rotationAroundVector(lookAngle, this.getXVector());
            this.setYVector(rot.rotate(playerUp));
            return this.setZVector(rot.rotate(playerDir));
        } else {
            lookDelta = 0.3;
            newLookVector = this.getZVector().mul(1.0 - lookDelta).plus((playerDir.minus(playerUp.mul(0.2)).normal()).mul(lookDelta));
            newLookVector.normalize();
            this.setZVector(newLookVector);
            this.setXVector(playerUp.cross(newLookVector).normal());
            return this.setYVector(newLookVector.cross(this.getXVector()).normal());
        }
    };

    Camera.prototype.followProjection = function() {
        var botToCamera, botToCameraNormal, camPos, cameraBotDistance, delta, desiredDistance, difference, horizontalAngle, lookDelta, mappedToXZ, newLeftVector, newLookVector, newUpVector, playerDir, playerLeft, playerPos, playerUp, rotFactor, rotQuat, upDelta, verticalAngle, wall_distance;
        camPos = this.getPosition();
        desiredDistance = 2.0;
        playerPos = this.player.currentPos();
        playerDir = this.player.currentDir();
        playerUp = this.player.currentUp();
        playerLeft = this.player.currentLeft();
        botToCamera = camPos.minus(playerPos);
        cameraBotDistance = botToCamera.length();
        if (cameraBotDistance >= desiredDistance) {
            difference = cameraBotDistance - desiredDistance;
            delta = difference * difference / 400.0;
            camPos = camPos.mul(1.0 - delta).plus(playerPos.mul(delta));
        } else {
            difference = desiredDistance - cameraBotDistance;
            delta = difference / 20.0;
            camPos = camPos.mul(1.0 - delta).plus((playerPos.plus(botToCamera.normal().mul(desiredDistance))).mul(delta));
        }
        botToCamera = camPos.minus(playerPos);
        botToCameraNormal = botToCamera.normal();
        verticalAngle = Vector.RAD2DEG(Math.acos(clamp(-1.0, 1.0, botToCameraNormal.dot(playerUp))));
        if (verticalAngle > 45) {
            rotQuat = Quaternion.rotationAroundVector(verticalAngle / 400.0, botToCameraNormal.cross(playerUp));
            botToCamera = rotQuat.rotate(botToCamera);
            botToCameraNormal = botToCamera.normal();
            camPos = playerPos.plus(botToCamera);
        }
        rotFactor = 1.0;
        wall_distance = world.getWallDistanceForPos(camPos);
        if (wall_distance < 0.5) {
            if (wall_distance < 0.2) {
                camPos = world.getInsideWallPosWithDelta(camPos, 0.2);
                botToCamera = camPos.minus(playerPos);
                botToCameraNormal = botToCamera.normal();
            }
            rotFactor = 0.5 / (wall_distance - 0.2);
        }
        mappedToXZ = (botToCamera.minus(playerUp.mul(botToCamera.dot(playerUp)))).normal();
        horizontalAngle = Vector.RAD2DEG(Math.acos(clamp(-1.0, 1.0, -playerDir.dot(mappedToXZ))));
        if (botToCameraNormal.dot(playerLeft) < 0) {
            horizontalAngle = -horizontalAngle;
        }
        rotQuat = Quaternion.rotationAroundVector(horizontalAngle / (rotFactor * 400.0), playerUp);
        camPos = playerPos.plus(rotQuat.rotate(botToCamera));
        botToCamera = camPos.minus(playerPos);
        botToCameraNormal = botToCamera.normal();
        this.setPosition(camPos);
        lookDelta = this.getZVector().dot(botToCameraNormal);
        lookDelta *= lookDelta / 30.0;
        newLookVector = this.getZVector().mul(1.0 - lookDelta).plus(botToCameraNormal.neg().mul(lookDelta));
        newLookVector.normalize();
        upDelta = 1.5 - this.getYVector().dot(playerUp);
        upDelta *= upDelta / 100.0;
        newUpVector = this.getYVector().mul(1.0 - upDelta).plus(playerUp.mul(upDelta));
        newUpVector.normalize();
        newLeftVector = newUpVector.cross(newLookVector);
        this.setXVector(newLeftVector);
        this.setYVector(newUpVector);
        this.setZVector(newLookVector);
        return this.projection;
    };

    return Camera;

})(Matrix);

module.exports = Camera;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FtZXJhLmpzIiwic291cmNlUm9vdCI6Ii4iLCJzb3VyY2VzIjpbIiJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBTUEsSUFBQSw4Q0FBQTtJQUFBOzs7QUFDQSxRQUNjLE9BQUEsQ0FBUSxlQUFSOztBQUNkLEdBQUEsR0FBYyxPQUFBLENBQVEsYUFBUjs7QUFDZCxNQUFBLEdBQWMsT0FBQSxDQUFRLGNBQVI7O0FBQ2QsTUFBQSxHQUFjLE9BQUEsQ0FBUSxjQUFSOztBQUNkLFVBQUEsR0FBYyxPQUFBLENBQVEsa0JBQVI7O0FBRVI7OztJQUVGLE1BQUMsQ0FBQSxNQUFELEdBQVU7O0lBQ1YsTUFBQyxDQUFBLE1BQUQsR0FBVTs7SUFDVixNQUFDLENBQUEsTUFBRCxHQUFVOztJQUVHLGdCQUFDLE1BQUQsRUFBVSxHQUFWO0FBQ1QsWUFBQTtRQURVLElBQUMsQ0FBQSxTQUFEO1FBQ1YsSUFBQyxDQUFBLEdBQUQsMERBQXFCO1FBQ3JCLElBQUMsQ0FBQSxJQUFELDZEQUFzQjtRQUN0QixJQUFDLENBQUEsWUFBRCxHQUFnQixJQUFDLENBQUE7UUFDakIsSUFBQyxDQUFBLEdBQUQsNERBQXFCO1FBQ3JCLElBQUMsQ0FBQSxJQUFELEdBQVUsTUFBTSxDQUFDO1FBQ2pCLElBQUMsQ0FBQSxNQUFELHdDQUF1QixDQUFDO1FBQ3hCLElBQUMsQ0FBQSxJQUFELEdBQVU7UUFDVixJQUFDLENBQUEsTUFBRCxHQUFVLENBQUMsQ0FBRCxFQUFHLENBQUgsRUFBSyxDQUFMLEVBQU8sQ0FBUDtRQUVWLHlDQUFBLFNBQUE7UUFFQSxJQUFDLENBQUEsV0FBRCxDQUFhLEdBQWIsRUFBa0IsR0FBbEIsRUFBdUIsR0FBdkIsRUFBNEIsR0FBNUI7UUFFQSxJQUFDLENBQUEsR0FBRCxHQUFPLElBQUksS0FBSyxDQUFDLGlCQUFWLENBQTRCLElBQUMsQ0FBQSxHQUE3QixFQUFrQyxJQUFDLENBQUEsTUFBbkMsRUFBMkMsSUFBQyxDQUFBLElBQTVDLEVBQWtELElBQUMsQ0FBQSxHQUFuRDtR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VTtRQUNyQixXQUFBLEdBQWMsSUFBQyxDQUFBLFVBQUQsQ0FBQSxDQUFhLENBQUMsR0FBZCxDQUFrQixHQUFBLEdBQUksT0FBdEIsQ0FBOEIsQ0FBQyxJQUEvQixDQUFvQyxRQUFRLENBQUMsR0FBVCxDQUFhLE9BQWIsQ0FBcEM7UUFDZCxXQUFXLENBQUMsU0FBWixDQUFBO1FBRUEsYUFBQSxHQUFnQixXQUFXLENBQUMsS0FBWixDQUFrQixhQUFsQjtRQUdoQixJQUFDLENBQUEsVUFBRCxDQUFZLGFBQVo7UUFDQSxJQUFDLENBQUEsVUFBRCxDQUFZLFdBQVo7UUFDQSxJQUFDLENBQUEsVUFBRCxDQUFZLGFBQVo7ZUFDQSxJQUFDLENBQUE7SUFoRmE7Ozs7R0F4SkQ7O0FBME9yQixNQUFNLENBQUMsT0FBUCxHQUFpQiIsInNvdXJjZXNDb250ZW50IjpbIlxuIyAgICAwMDAwMDAwICAgMDAwMDAwMCAgIDAwICAgICAwMCAgMDAwMDAwMDAgIDAwMDAwMDAwICAgIDAwMDAwMDAgXG4jICAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAwMDBcbiMgICAwMDAgICAgICAgMDAwMDAwMDAwICAwMDAwMDAwMDAgIDAwMDAwMDAgICAwMDAwMDAwICAgIDAwMDAwMDAwMFxuIyAgIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAwIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwXG4jICAgIDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAwMDAwMCAgMDAwICAgMDAwICAwMDAgICAwMDBcbntcbmNsYW1wXG59ICAgICAgICAgICA9IHJlcXVpcmUgJy4vdG9vbHMvdG9vbHMnXG5sb2cgICAgICAgICA9IHJlcXVpcmUgJy4vdG9vbHMvbG9nJ1xuTWF0cml4ICAgICAgPSByZXF1aXJlICcuL2xpYi9tYXRyaXgnXG5WZWN0b3IgICAgICA9IHJlcXVpcmUgJy4vbGliL3ZlY3RvcidcblF1YXRlcm5pb24gID0gcmVxdWlyZSAnLi9saWIvcXVhdGVybmlvbidcblxuY2xhc3MgQ2FtZXJhIGV4dGVuZHMgTWF0cml4XG5cbiAgICBASU5TSURFID0gMCBcbiAgICBAQkVISU5EID0gMSBcbiAgICBARk9MTE9XID0gMlxuICAgICAgICBcbiAgICBjb25zdHJ1Y3RvcjogKEBwbGF5ZXIsIG9wdCkgLT5cbiAgICAgICAgQGZvdiAgICA9IG9wdD8uZm92ID8gOTBcbiAgICAgICAgQG5lYXIgICA9IG9wdD8ubmVhciA/IDAuMDFcbiAgICAgICAgQGV5ZV9kaXN0YW5jZSA9IEBuZWFyXG4gICAgICAgIEBmYXIgICAgPSBvcHQ/LmZhciA/IDMwXG4gICAgICAgIEBtb2RlICAgPSBDYW1lcmEuQkVISU5EXG4gICAgICAgIEBhc3BlY3QgPSBvcHQuYXNwZWN0ID8gLTFcbiAgICAgICAgQGRpc3QgICA9IDEwXG4gICAgICAgIEBib3JkZXIgPSBbMCwwLDAsMF1cbiAgICAgICAgXG4gICAgICAgIHN1cGVyXG4gICAgICAgIFxuICAgICAgICBAc2V0Vmlld3BvcnQgMC4wLCAwLjAsIDEuMCwgMS4wIFxuICAgICAgICBcbiAgICAgICAgQGNhbSA9IG5ldyBUSFJFRS5QZXJzcGVjdGl2ZUNhbWVyYSBAZm92LCBAYXNwZWN0LCBAbmVhciwgQGZhclxuICAgICAgICBAY2FtLnBvc2l0aW9uLnogPSBAZGlzdFxuICAgICAgICBcbiAgICBzdGVwOiAoc3RlcCkgLT5cbiAgICAgICAgXG4gICAgICAgIHN3aXRjaCBAbW9kZVxuICAgICAgICAgICAgd2hlbiBDYW1lcmEuSU5TSURFIHRoZW4gQGluc2lkZVByb2plY3Rpb24oKSAgICAgXG4gICAgICAgICAgICB3aGVuIENhbWVyYS5CRUhJTkQgdGhlbiBAYmVoaW5kUHJvamVjdGlvbigpXG4gICAgICAgICAgICB3aGVuIENhbWVyYS5GT0xMT1cgdGhlbiBAZm9sbG93UHJvamVjdGlvbigpXG4gICAgICAgIFxuICAgICAgICBjYW1Qb3MgPSBAZ2V0UG9zaXRpb24oKVxuICAgICAgICBAY2FtLnBvc2l0aW9uLmNvcHkgY2FtUG9zXG4gICAgICAgIEBjYW0udXAuY29weSBAZ2V0WVZlY3RvcigpXG4gICAgICAgIEBjYW0ubG9va0F0IGNhbVBvcy5wbHVzIEBnZXRaVmVjdG9yKClcblxuICAgICAgICBpZiBAbGlnaHQ/XG4gICAgICAgICAgICBwb3MgPSBAZ2V0UG9zaXRpb24oKS5wbHVzIEBsaWdodF9vZmZzZXRcbiAgICAgICAgICAgIEBsaWdodC5zZXREaXJlY3Rpb24gLUBnZXRaVmVjdG9yKClcbiAgICAgICAgICAgIEBsaWdodC5zZXRQb3NpdGlvbiBuZXcgVmVjdG9yIHBvc1tYXSwgcG9zW1ldLCBwb3NbWl0sIDEuMCAjIHBvc2l0aW9uYWwgbGlnaHQgc291cmNlXG4gICAgXG4gICAgZ2V0TG9va0F0UG9zaXRpb246IC0+IEBnZXRaVmVjdG9yKCkubXVsKC1AZXllX2Rpc3RhbmNlKS5wbHVzIEBnZXRQb3NpdGlvbigpXG4gICAgXG4gICAgc2V0T3JpZW50YXRpb246IChvKSAtPiBcbiAgICAgICAgQHNldFlWZWN0b3Igby5yb3RhdGUgVmVjdG9yLnVuaXRZXG4gICAgICAgIEBzZXRaVmVjdG9yIG8ucm90YXRlIFZlY3Rvci51bml0WlxuICAgICAgICBAc2V0WFZlY3RvciBvLnJvdGF0ZSBWZWN0b3IubWludXNYXG4gICAgICAgIEBjYW0udXAuY29weSBAZ2V0WVZlY3RvcigpXG4gICAgICAgIEBjYW0ubG9va0F0IEBnZXRQb3NpdGlvbigpLnBsdXMgQGdldFpWZWN0b3IoKVxuICAgICAgICAgICAgXG4gICAgdXBkYXRlVmlld3BvcnQ6IC0+XG4gICAgICAgICMgc3MgPSB3b3JsZC5zY3JlZW5TaXplXG4gICAgICAgICMgdnAgPSBbXVxuICAgICAgICAjIHZwWzBdID0gQHZpZXdwb3J0WzBdICogc3MudyArIEBib3JkZXJbMF1cbiAgICAgICAgIyB2cFsxXSA9IEB2aWV3cG9ydFsxXSAqIHNzLmggKyBAYm9yZGVyWzFdXG4gICAgICAgICMgdnBbMl0gPSBAdmlld3BvcnRbMl0gKiBzcy53IC0gQGJvcmRlclswXSAtIEBib3JkZXJbMl1cbiAgICAgICAgIyB2cFszXSA9IEB2aWV3cG9ydFszXSAqIHNzLmggLSBAYm9yZGVyWzFdIC0gQGJvcmRlclszXVxuICAgIFxuICAgIHNldFZpZXdwb3J0Qm9yZGVyOiAobCwgYiwgciwgdCkgLT5cbiAgICAgICAgIyBAYm9yZGVyID0gW2wsYixyLHRdXG4gICAgICAgICMgQHVwZGF0ZVZpZXdwb3J0KClcbiAgICBcbiAgICBzZXRWaWV3cG9ydDogKGwsIGIsIHcsIGgpIC0+XG4gICAgICAgICMgQHZpZXdwb3J0ID0gW2wsYix3LGhdIFxuICAgICAgICAjIEB1cGRhdGVWaWV3cG9ydCgpXG4jICAgICBcbiAgICBzZXRGb3Y6IChmb3YpIC0+IEBmb3YgPSBNYXRoLm1heCgyLjAsIE1hdGgubWluIGZvdiwgMTc1LjApXG4gICAgICAgICAgICBcbiAgICAjICAgMDAwMDAwMDAgICAwMDAwMDAwMCAgICAwMDAwMDAwICAgICAgICAgMDAwICAwMDAwMDAwMCAgIDAwMDAwMDAgIDAwMDAwMDAwMCAgMDAwICAgMDAwMDAwMCAgIDAwMCAgIDAwMFxuICAgICMgICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAgICAgICAwMDAgIDAwMCAgICAgICAwMDAgICAgICAgICAgMDAwICAgICAwMDAgIDAwMCAgIDAwMCAgMDAwMCAgMDAwXG4gICAgIyAgIDAwMDAwMDAwICAgMDAwMDAwMCAgICAwMDAgICAwMDAgICAgICAgIDAwMCAgMDAwMDAwMCAgIDAwMCAgICAgICAgICAwMDAgICAgIDAwMCAgMDAwICAgMDAwICAwMDAgMCAwMDBcbiAgICAjICAgMDAwICAgICAgICAwMDAgICAwMDAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgICAgICAgIDAwMCAgICAgMDAwICAwMDAgICAwMDAgIDAwMCAgMDAwMFxuICAgICMgICAwMDAgICAgICAgIDAwMCAgIDAwMCAgIDAwMDAwMDAgICAgMDAwMDAwMCAgIDAwMDAwMDAwICAgMDAwMDAwMCAgICAgMDAwICAgICAwMDAgICAwMDAwMDAwICAgMDAwICAgMDAwXG4gICAgXG4gICAgaW5zaWRlUHJvamVjdGlvbjogKCkgLT5cbiAgICAgICAgXG4gICAgICAgIHBsYXllclBvcyA9IEBwbGF5ZXIuY3VycmVudFBvcygpXG4gICAgICAgIHBsYXllckRpciA9IEBwbGF5ZXIuY3VycmVudERpcigpXG4gICAgICAgIHBsYXllclVwICA9IEBwbGF5ZXIuY3VycmVudFVwKClcbiAgICAgICAgbG9va0FuZ2xlID0gQHBsYXllci5sb29rX2FuZ2xlXG4gICAgICAgIFxuICAgICAgICBwb3NEZWx0YSA9IHdvcmxkLmdldFNwZWVkKCkgLyAxMC4wICMgc21vb3RoIGNhbWVyYSBtb3ZlbWVudCBhIGxpdHRsZSBiaXRcbiAgICAgICAgY2FtUG9zID0gcGxheWVyUG9zXG4gICAgICAgIGlmIGxvb2tBbmdsZSA8IDBcbiAgICAgICAgICAgIGNhbVBvcy5hZGQgcGxheWVyVXAubXVsIC0yKmxvb2tBbmdsZS85MFxuICAgICAgICBAc2V0UG9zaXRpb24gQGdldFBvc2l0aW9uKCkubXVsKDEuMC1wb3NEZWx0YSkucGx1cyBjYW1Qb3MubXVsIHBvc0RlbHRhXG4gICAgICAgICAgICBcbiAgICAgICAgaWYgbG9va0FuZ2xlICMgcGxheWVyIGlzIGxvb2tpbmcgdXAgb3IgZG93blxuICAgICAgICAgICAgQHNldFhWZWN0b3IgcGxheWVyRGlyLmNyb3NzKHBsYXllclVwKS5ub3JtYWwoKVxuICAgICAgICAgICAgcm90ID0gUXVhdGVybmlvbi5yb3RhdGlvbkFyb3VuZFZlY3RvciBsb29rQW5nbGUsIEBnZXRYVmVjdG9yKClcbiAgICAgICAgICAgIEBzZXRZVmVjdG9yIHJvdC5yb3RhdGUgcGxheWVyVXAgXG4gICAgICAgICAgICBAc2V0WlZlY3RvciByb3Qucm90YXRlIHBsYXllckRpciAjLm5lZygpXG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgICMgc21vb3RoIGNhbWVyYSByb3RhdGlvbiBhIGxpdHRsZSBiaXRcbiAgICAgICAgICAgIGxvb2tEZWx0YSA9ICgyLjAgLSBAZ2V0WlZlY3RvcigpLmRvdCBwbGF5ZXJEaXIpICogd29ybGQuZ2V0U3BlZWQoKSAvIDUwLjBcbiAgICAgICAgICAgIG5ld0xvb2tWZWN0b3IgPSBAZ2V0WlZlY3RvcigpLm11bCgxLjAgLSBsb29rRGVsdGEpLnBsdXMgcGxheWVyRGlyLm11bCBsb29rRGVsdGFcbiAgICAgICAgICAgIG5ld0xvb2tWZWN0b3Iubm9ybWFsaXplKClcbiAgICAgICAgICAgIEBzZXRYVmVjdG9yIHBsYXllclVwLmNyb3NzKG5ld0xvb2tWZWN0b3IpLm5vcm1hbCgpXG4gICAgICAgICAgICBAc2V0WVZlY3RvciBwbGF5ZXJVcFxuICAgICAgICAgICAgQHNldFpWZWN0b3IgbmV3TG9va1ZlY3RvclxuICAgICAgICAgICAgXG4gICAgICAgIEBwcm9qZWN0aW9uXG4gICAgXG4gICAgIyAgIDAwMDAwMDAgICAgMDAwMDAwMDAgIDAwMCAgIDAwMCAgMDAwICAwMDAgICAwMDAgIDAwMDAwMDAgIFxuICAgICMgICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDAgIDAwMCAgMDAwMCAgMDAwICAwMDAgICAwMDBcbiAgICAjICAgMDAwMDAwMCAgICAwMDAwMDAwICAgMDAwMDAwMDAwICAwMDAgIDAwMCAwIDAwMCAgMDAwICAgMDAwXG4gICAgIyAgIDAwMCAgIDAwMCAgMDAwICAgICAgIDAwMCAgIDAwMCAgMDAwICAwMDAgIDAwMDAgIDAwMCAgIDAwMFxuICAgICMgICAwMDAwMDAwICAgIDAwMDAwMDAwICAwMDAgICAwMDAgIDAwMCAgMDAwICAgMDAwICAwMDAwMDAwICBcbiAgICBcbiAgICBiZWhpbmRQcm9qZWN0aW9uOiAoKSAtPlxuICAgICAgICBwbGF5ZXJQb3MgPSBAcGxheWVyLmN1cnJlbnRQb3MoKVxuICAgICAgICBwbGF5ZXJEaXIgPSBAcGxheWVyLmN1cnJlbnREaXIoKVxuICAgICAgICBwbGF5ZXJVcCAgPSBAcGxheWVyLmN1cnJlbnRVcCgpXG4gICAgICAgIGxvb2tBbmdsZSA9IEBwbGF5ZXIubG9va19hbmdsZVxuICAgICAgICBcbiAgICAgICAgIyBmaW5kIGEgdmFsaWQgY2FtZXJhIHBvc2l0aW9uXG4gICAgICAgIGJvdFRvQ2FtZXJhID0gcGxheWVyVXAubWludXMgcGxheWVyRGlyLm11bCAyXG4gICAgICAgIG1pbl9mID0gYm90VG9DYW1lcmEubGVuZ3RoKClcbiAgICAgICAgYm90VG9DYW1lcmEubm9ybWFsaXplKClcbiAgICAgICAgXG4gICAgICAgIG1pbl9mID0gTWF0aC5taW4gd29ybGQuZ2V0V2FsbERpc3RhbmNlRm9yUmF5KHBsYXllclBvcywgYm90VG9DYW1lcmEpLCBtaW5fZlxuICAgICAgICBjYW1Qb3MgPSBwbGF5ZXJQb3MucGx1cyBib3RUb0NhbWVyYS5tdWwgTWF0aC5tYXgobWluX2YsIDAuNzIpICogKDEtTWF0aC5hYnMobG9va0FuZ2xlKS85MClcbiAgICAgICAgaWYgbG9va0FuZ2xlIDwgMFxuICAgICAgICAgICAgY2FtUG9zLmFkZCBwbGF5ZXJVcC5tdWwgLTIqbG9va0FuZ2xlLzkwXG4gICAgICAgIFxuICAgICAgICBjYW1Qb3MgPSB3b3JsZC5nZXRJbnNpZGVXYWxsUG9zV2l0aERlbHRhIGNhbVBvcywgMC4yXG4gICAgICAgICAgICBcbiAgICAgICAgIyBzbW9vdGggY2FtZXJhIG1vdmVtZW50IGEgbGl0dGxlIGJpdFxuICAgICAgICBwb3NEZWx0YSA9IDAuMlxuICAgICAgICBAc2V0UG9zaXRpb24gQGdldFBvc2l0aW9uKCkubXVsKDEuMCAtIHBvc0RlbHRhKS5wbHVzIGNhbVBvcy5tdWwgcG9zRGVsdGFcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIGlmIGxvb2tBbmdsZVxuICAgICAgICAgICAgIyBsb2cgXCJsb29rX2FuZ2xlICN7bG9va0FuZ2xlfVwiXG4gICAgICAgICAgICBAc2V0WFZlY3RvciBwbGF5ZXJEaXIuY3Jvc3MocGxheWVyVXApLm5vcm1hbCgpIFxuICAgICAgICAgICAgcm90ID0gUXVhdGVybmlvbi5yb3RhdGlvbkFyb3VuZFZlY3RvciBsb29rQW5nbGUsIEBnZXRYVmVjdG9yKCkgXG4gICAgICAgICAgICBAc2V0WVZlY3RvciByb3Qucm90YXRlIHBsYXllclVwICBcbiAgICAgICAgICAgIEBzZXRaVmVjdG9yIHJvdC5yb3RhdGUgcGxheWVyRGlyICMubmVnKCkgIFxuICAgICAgICBlbHNlXG4gICAgICAgICAgICAjIHNtb290aCBjYW1lcmEgcm90YXRpb24gYSBsaXR0bGUgYml0XG4gICAgICAgICAgICBsb29rRGVsdGEgPSAwLjNcbiAgICAgICAgICAgIG5ld0xvb2tWZWN0b3IgPSBAZ2V0WlZlY3RvcigpLm11bCgxLjAgLSBsb29rRGVsdGEpLnBsdXMgKHBsYXllckRpci5taW51cyhwbGF5ZXJVcC5tdWwoMC4yKSkubm9ybWFsKCkpLm11bCBsb29rRGVsdGFcbiAgICAgICAgICAgIG5ld0xvb2tWZWN0b3Iubm9ybWFsaXplKClcbiAgICAgICAgICAgIFxuICAgICAgICAgICAgQHNldFpWZWN0b3IgbmV3TG9va1ZlY3RvciAgXG4gICAgICAgICAgICBAc2V0WFZlY3RvciBwbGF5ZXJVcC5jcm9zcyhuZXdMb29rVmVjdG9yKS5ub3JtYWwoKSBcbiAgICAgICAgICAgIEBzZXRZVmVjdG9yIG5ld0xvb2tWZWN0b3IuY3Jvc3MoQGdldFhWZWN0b3IoKSkubm9ybWFsKCkgXG4gICAgICAgIFxuICAgICMgICAwMDAwMDAwMCAgIDAwMDAwMDAgICAwMDAgICAgICAwMDAgICAgICAgMDAwMDAwMCAgIDAwMCAgIDAwMFxuICAgICMgICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgICAgICAwMDAgICAwMDAgIDAwMCAwIDAwMFxuICAgICMgICAwMDAwMDAgICAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgICAgICAwMDAgICAwMDAgIDAwMDAwMDAwMFxuICAgICMgICAwMDAgICAgICAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgICAgICAwMDAgICAwMDAgIDAwMCAgIDAwMFxuICAgICMgICAwMDAgICAgICAgIDAwMDAwMDAgICAwMDAwMDAwICAwMDAwMDAwICAgMDAwMDAwMCAgIDAwICAgICAwMFxuXG4gICAgZm9sbG93UHJvamVjdGlvbjogKCkgLT5cbiAgICAgICAgXG4gICAgICAgIGNhbVBvcyA9IEBnZXRQb3NpdGlvbigpXG4gICAgICAgIGRlc2lyZWREaXN0YW5jZSA9IDIuMCAjIGRlc2lyZWQgZGlzdGFuY2UgZnJvbSBjYW1lcmEgdG8gYm90XG4gICAgXG4gICAgICAgIHBsYXllclBvcyAgID0gQHBsYXllci5jdXJyZW50UG9zKClcbiAgICAgICAgcGxheWVyRGlyICAgPSBAcGxheWVyLmN1cnJlbnREaXIoKVxuICAgICAgICBwbGF5ZXJVcCAgICA9IEBwbGF5ZXIuY3VycmVudFVwKClcbiAgICAgICAgcGxheWVyTGVmdCAgPSBAcGxheWVyLmN1cnJlbnRMZWZ0KClcbiAgICBcbiAgICAgICAgIyBmaXJzdCwgYWRqdXN0IGRpc3RhbmNlIGZyb20gY2FtZXJhIHRvIGJvdFxuICAgICAgICAgXG4gICAgICAgIGJvdFRvQ2FtZXJhID0gY2FtUG9zLm1pbnVzIHBsYXllclBvcyAgICAgIyB2ZWN0b3IgZnJvbSBib3QgdG8gY3VycmVudCBwb3NcbiAgICAgICAgY2FtZXJhQm90RGlzdGFuY2UgPSBib3RUb0NhbWVyYS5sZW5ndGgoKSAjIGRpc3RhbmNlIGZyb20gY2FtZXJhIHRvIGJvdFxuICAgICAgICBcbiAgICAgICAgaWYgY2FtZXJhQm90RGlzdGFuY2UgPj0gZGVzaXJlZERpc3RhbmNlXG4gICAgICAgICAgICBkaWZmZXJlbmNlID0gY2FtZXJhQm90RGlzdGFuY2UgLSBkZXNpcmVkRGlzdGFuY2VcbiAgICAgICAgICAgIGRlbHRhID0gZGlmZmVyZW5jZSpkaWZmZXJlbmNlLzQwMC4wICAjIHdlaWdodCBmb3IgZm9sbG93aW5nIHNwZWVkXG4gICAgICAgICAgICBjYW1Qb3MgPSBjYW1Qb3MubXVsKDEuMC1kZWx0YSkucGx1cyBwbGF5ZXJQb3MubXVsIGRlbHRhXG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGRpZmZlcmVuY2UgPSBkZXNpcmVkRGlzdGFuY2UgLSBjYW1lcmFCb3REaXN0YW5jZVxuICAgICAgICAgICAgZGVsdGEgPSBkaWZmZXJlbmNlLzIwLjAgIyB3ZWlnaHQgZm9yIG5lZ2F0aXZlIGZvbGxvd2luZyBzcGVlZFxuICAgICAgICAgICAgY2FtUG9zID0gY2FtUG9zLm11bCgxLjAtZGVsdGEpLnBsdXMgKHBsYXllclBvcy5wbHVzIGJvdFRvQ2FtZXJhLm5vcm1hbCgpLm11bCBkZXNpcmVkRGlzdGFuY2UpLm11bCBkZWx0YVxuICAgIFxuICAgICAgICAjIHNlY29uZCwgcm90YXRlIGFyb3VuZCBib3RcbiAgICBcbiAgICAgICAgYm90VG9DYW1lcmEgPSBjYW1Qb3MubWludXMgcGxheWVyUG9zXG4gICAgICAgIGJvdFRvQ2FtZXJhTm9ybWFsID0gYm90VG9DYW1lcmEubm9ybWFsKClcbiAgICAgXG4gICAgICAgICMgcm90YXRlIGNhbWVyYSB2ZXJ0aWNhbGx5XG4gICAgICAgIHZlcnRpY2FsQW5nbGUgPSBWZWN0b3IuUkFEMkRFRyBNYXRoLmFjb3MoY2xhbXAoLTEuMCwgMS4wLCBib3RUb0NhbWVyYU5vcm1hbC5kb3QgcGxheWVyVXApKVxuICAgICAgICBpZiB2ZXJ0aWNhbEFuZ2xlID4gNDVcbiAgICAgICAgICAgICMgbG9nIFwidmVydGljYWxBbmdsZSAje3ZlcnRpY2FsQW5nbGV9XCJcbiAgICAgICAgICAgIHJvdFF1YXQgICAgID0gUXVhdGVybmlvbi5yb3RhdGlvbkFyb3VuZFZlY3Rvcih2ZXJ0aWNhbEFuZ2xlLzQwMC4wLCBib3RUb0NhbWVyYU5vcm1hbC5jcm9zcyhwbGF5ZXJVcCkpXG4gICAgICAgICAgICBib3RUb0NhbWVyYSA9IHJvdFF1YXQucm90YXRlIGJvdFRvQ2FtZXJhIFxuICAgICAgICAgICAgYm90VG9DYW1lcmFOb3JtYWwgPSBib3RUb0NhbWVyYS5ub3JtYWwoKVxuICAgICAgICAgICAgY2FtUG9zICAgICAgPSBwbGF5ZXJQb3MucGx1cyBib3RUb0NhbWVyYVxuXG4gICAgICAgIHJvdEZhY3RvciA9IDEuMFxuXG4gICAgICAgIHdhbGxfZGlzdGFuY2UgPSB3b3JsZC5nZXRXYWxsRGlzdGFuY2VGb3JQb3MgY2FtUG9zXG4gICAgICAgIGlmIHdhbGxfZGlzdGFuY2UgPCAwLjUgIyB0cnkgYXZvaWQgcGllcmNpbmcgd2FsbHNcbiAgICAgICAgICAgIGlmIHdhbGxfZGlzdGFuY2UgPCAwLjJcbiAgICAgICAgICAgICAgICBjYW1Qb3MgPSB3b3JsZC5nZXRJbnNpZGVXYWxsUG9zV2l0aERlbHRhIGNhbVBvcywgMC4yXG4gICAgICAgICAgICAgICAgYm90VG9DYW1lcmEgPSBjYW1Qb3MubWludXMgcGxheWVyUG9zXG4gICAgICAgICAgICAgICAgYm90VG9DYW1lcmFOb3JtYWwgPSBib3RUb0NhbWVyYS5ub3JtYWwoKVxuICAgICAgICAgICAgcm90RmFjdG9yID0gMC41IC8gKHdhbGxfZGlzdGFuY2UtMC4yKVxuICAgICBcbiAgICAgICAgIyB0cnkgdmlldyBib3QgZnJvbSBiZWhpbmRcbiAgICAgICAgIyBjYWxjdWxhdGUgaG9yaXpvbnRhbCBhbmdsZSBiZXR3ZWVuIGJvdCBvcmllbnRhdGlvbiBhbmQgdmVjdG9yIHRvIGNhbWVyYVxuICAgICAgICBtYXBwZWRUb1haID0gKGJvdFRvQ2FtZXJhLm1pbnVzIHBsYXllclVwLm11bChib3RUb0NhbWVyYS5kb3QgcGxheWVyVXApKS5ub3JtYWwoKVxuICAgICAgICBob3Jpem9udGFsQW5nbGUgPSBWZWN0b3IuUkFEMkRFRyBNYXRoLmFjb3MoY2xhbXAoLTEuMCwgMS4wLCAtcGxheWVyRGlyLmRvdCBtYXBwZWRUb1haKSlcbiAgICAgICAgaWYgYm90VG9DYW1lcmFOb3JtYWwuZG90KHBsYXllckxlZnQpIDwgMFxuICAgICAgICAgICAgaG9yaXpvbnRhbEFuZ2xlID0gLWhvcml6b250YWxBbmdsZVxuICAgICAgICByb3RRdWF0ID0gUXVhdGVybmlvbi5yb3RhdGlvbkFyb3VuZFZlY3RvciBob3Jpem9udGFsQW5nbGUvKHJvdEZhY3Rvcio0MDAuMCksIHBsYXllclVwIFxuICAgICAgICBjYW1Qb3MgPSBwbGF5ZXJQb3MucGx1cyByb3RRdWF0LnJvdGF0ZSBib3RUb0NhbWVyYVxuXG4gICAgICAgIGJvdFRvQ2FtZXJhID0gY2FtUG9zLm1pbnVzIHBsYXllclBvc1xuICAgICAgICBib3RUb0NhbWVyYU5vcm1hbCA9IGJvdFRvQ2FtZXJhLm5vcm1hbCgpXG4gICAgXG4gICAgICAgIEBzZXRQb3NpdGlvbiBjYW1Qb3MgIyBmaW5hbGx5LCBzZXQgdGhlIHBvc2l0aW9uXG4gICAgICAgIFxuICAgICAgICAjIHNsb3dseSBhZGp1c3QgbG9vayBkaXJlY3Rpb24gYnkgaW50ZXJwb2xhdGluZyBjdXJyZW50IGFuZCBkZXNpcmVkIGRpcmVjdGlvbnNcbiAgICAgICAgbG9va0RlbHRhID0gQGdldFpWZWN0b3IoKS5kb3QgYm90VG9DYW1lcmFOb3JtYWxcbiAgICAgICAgbG9va0RlbHRhICo9IGxvb2tEZWx0YSAvIDMwLjAgICAgXG4gICAgICAgIG5ld0xvb2tWZWN0b3IgPSBAZ2V0WlZlY3RvcigpLm11bCgxLjAtbG9va0RlbHRhKS5wbHVzIGJvdFRvQ2FtZXJhTm9ybWFsLm5lZygpLm11bChsb29rRGVsdGEpXG4gICAgICAgIG5ld0xvb2tWZWN0b3Iubm9ybWFsaXplKClcbiAgICAgICAgXG4gICAgICAgICMgc2xvd2x5IGFkanVzdCB1cCB2ZWN0b3IgYnkgaW50ZXJwb2xhdGluZyBjdXJyZW50IGFuZCBkZXNpcmVkIHVwIHZlY3RvcnNcbiAgICAgICAgdXBEZWx0YSA9IDEuNS1AZ2V0WVZlY3RvcigpLmRvdCBwbGF5ZXJVcFxuICAgICAgICB1cERlbHRhICo9IHVwRGVsdGEgLyAxMDAuMCAgICBcbiAgICAgICAgbmV3VXBWZWN0b3IgPSBAZ2V0WVZlY3RvcigpLm11bCgxLjAtdXBEZWx0YSkucGx1cyBwbGF5ZXJVcC5tdWwodXBEZWx0YSlcbiAgICAgICAgbmV3VXBWZWN0b3Iubm9ybWFsaXplKClcbiAgICAgICAgXG4gICAgICAgIG5ld0xlZnRWZWN0b3IgPSBuZXdVcFZlY3Rvci5jcm9zcyBuZXdMb29rVmVjdG9yXG4gICAgXG4gICAgICAgICMgZmluaXNoZWQgaW50ZXJwb2xhdGlvbnMsIHVwZGF0ZSBjYW1lcmEgbWF0cml4XG4gICAgICAgIEBzZXRYVmVjdG9yIG5ld0xlZnRWZWN0b3JcbiAgICAgICAgQHNldFlWZWN0b3IgbmV3VXBWZWN0b3JcbiAgICAgICAgQHNldFpWZWN0b3IgbmV3TG9va1ZlY3RvclxuICAgICAgICBAcHJvamVjdGlvblxuICAgICAgICBcbm1vZHVsZS5leHBvcnRzID0gQ2FtZXJhIl19
//# sourceURL=../coffee/camera.coffee