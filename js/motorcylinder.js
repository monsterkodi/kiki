// koffee 1.4.0
var Action, Face, Geom, Item, Material, MotorCylinder, Pushable, klog,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

klog = require('kxk').klog;

Item = require('./item');

Action = require('./action');

Face = require('./face');

Geom = require('./geom');

Pushable = require('./pushable');

Material = require('./material');

MotorCylinder = (function(superClass) {
    extend(MotorCylinder, superClass);

    MotorCylinder.prototype.isSpaceEgoistic = function() {
        return true;
    };

    function MotorCylinder(face) {
        this.face = face;
        MotorCylinder.__super__.constructor.call(this);
        this.value = 0.0;
        this.active = false;
        this.orientation = Face.orientationForFace(this.face);
        this.addAction(new Action(this, Action.TUCKER, 'tucker', 500, Action.REPEAT));
    }

    MotorCylinder.prototype.setPosition = function(pos) {
        MotorCylinder.__super__.setPosition.call(this, pos);
        return this.updateActive();
    };

    MotorCylinder.prototype.del = function() {
        this.kolben.geometry.dispose();
        this.mesh.geometry.dispose();
        return MotorCylinder.__super__.del.apply(this, arguments);
    };

    MotorCylinder.prototype.createMesh = function() {
        this.mesh = new THREE.Mesh(Geom.cylinder(), Material.plate);
        this.kolben = new THREE.Mesh(Geom.kolben(), Material.gear);
        this.mesh.add(this.kolben);
        this.mesh.receiveShadow = true;
        return this.mesh.castShadow = true;
    };

    MotorCylinder.prototype.updateMesh = function() {
        this.kolben.position.set(0, 0, -0.5 * Math.sin(this.value));
        return this.mesh.quaternion.copy(Face.orientation(this.face));
    };

    MotorCylinder.prototype.setActive = function(active) {
        if (this.active !== active) {
            this.active = active;
            if (this.active) {
                return this.startTimedAction(this.getActionWithId(Action.TUCKER));
            } else {
                return this.stopAction(this.getActionWithId(Action.TUCKER));
            }
        }
    };

    MotorCylinder.prototype.initAction = function(action) {
        var MotorGear, isGear, occupant, pos, ref;
        if ((ref = action.id) === Action.PUSH || ref === Action.FALL) {
            this.setActive(false);
            pos = this.position.minus(Face.normal(this.face));
            occupant = world.getOccupantAtPos(pos);
            MotorGear = require('./motorgear');
            isGear = occupant instanceof MotorGear && occupant.face === this.face;
            klog("initAction isGear " + isGear);
            if (isGear) {
                occupant.setActive(false);
            }
        }
        return MotorCylinder.__super__.initAction.call(this, action);
    };

    MotorCylinder.prototype.performAction = function(action) {
        var relTime;
        if (action.id === Action.TUCKER) {
            relTime = action.getRelativeTime();
            this.value = relTime > 0.5 ? 1.0 - relTime : relTime;
            this.value *= 2;
            this.updateMesh();
            return;
        }
        return MotorCylinder.__super__.performAction.call(this, action);
    };

    MotorCylinder.prototype.finishAction = function(action) {
        var ref;
        if (action.id === Action.TUCKER) {
            world.playSound('MOTOR', this.getPos());
            return;
        }
        MotorCylinder.__super__.finishAction.call(this, action);
        if ((ref = action.id) === Action.PUSH || ref === Action.FALL) {
            return this.updateActive();
        }
    };

    MotorCylinder.prototype.updateActive = function() {
        var MotorGear, isGear, occupant, pos;
        pos = this.position.minus(Face.normal(this.face));
        occupant = world.getOccupantAtPos(pos);
        MotorGear = require('./motorgear');
        isGear = occupant instanceof MotorGear && occupant.face === this.face;
        this.setActive(isGear);
        if (isGear) {
            return occupant.setActive(true);
        }
    };

    return MotorCylinder;

})(Pushable);

module.exports = MotorCylinder;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW90b3JjeWxpbmRlci5qcyIsInNvdXJjZVJvb3QiOiIuIiwic291cmNlcyI6WyIiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQU1BLElBQUEsaUVBQUE7SUFBQTs7O0FBQUUsT0FBUyxPQUFBLENBQVEsS0FBUjs7QUFDWCxJQUFBLEdBQVksT0FBQSxDQUFRLFFBQVI7O0FBQ1osTUFBQSxHQUFZLE9BQUEsQ0FBUSxVQUFSOztBQUNaLElBQUEsR0FBWSxPQUFBLENBQVEsUUFBUjs7QUFDWixJQUFBLEdBQVksT0FBQSxDQUFRLFFBQVI7O0FBQ1osUUFBQSxHQUFZLE9BQUEsQ0FBUSxZQUFSOztBQUNaLFFBQUEsR0FBWSxPQUFBLENBQVEsWUFBUjs7QUFFTjs7OzRCQUVGLGVBQUEsR0FBaUIsU0FBQTtlQUFHO0lBQUg7O0lBRWQsdUJBQUMsSUFBRDtRQUFDLElBQUMsQ0FBQSxPQUFEO1FBQ0EsNkNBQUE7UUFDQSxJQUFDLENBQUEsS0FBRCxHQUFTO1FBQ1QsSUFBQyxDQUFBLE1BQUQsR0FBVTtRQUNWLElBQUMsQ0FBQSxXQUFELEdBQWUsSUFBSSxDQUFDLGtCQUFMLENBQXdCLElBQUMsQ0FBQSxJQUF6QjtRQUNmLElBQUMsQ0FBQSxTQUFELENBQVcsSUFBSSxNQUFKLENBQVcsSUFBWCxFQUFjLE1BQU0sQ0FBQyxNQUFyQixFQUE2QixRQUE3QixFQUFzQyxHQUF0QyxFQUEwQyxNQUFNLENBQUMsTUFBakQsQ0FBWDtJQUxEOzs0QkFPSCxXQUFBLEdBQWEsU0FBQyxHQUFEO1FBQ1QsK0NBQU0sR0FBTjtlQUNBLElBQUMsQ0FBQSxZQUFELENBQUE7SUFGUzs7NEJBSWIsR0FBQSxHQUFLLFNBQUE7UUFFRCxJQUFDLENBQUEsTUFBTSxDQUFDLFFBQVEsQ0FBQyxPQUFqQixDQUFBO1FBQ0EsSUFBQyxDQUFBLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBZixDQUFBO2VBQ0Esd0NBQUEsU0FBQTtJQUpDOzs0QkFNTCxVQUFBLEdBQVksU0FBQTtRQUVSLElBQUMsQ0FBQSxJQUFE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QUFDLElBQXJCLElBQUEsR0FBQSxLQUEyQixNQUFNLENBQUMsSUFBckM7bUJBQ0ksSUFBQyxDQUFBLFlBQUQsQ0FBQSxFQURKOztJQUxVOzs0QkFRZCxZQUFBLEdBQWMsU0FBQTtBQUNWLFlBQUE7UUFBQSxHQUFBLEdBQU0sSUFBQyxDQUFBLFFBQVEsQ0FBQyxLQUFWLENBQWdCLElBQUksQ0FBQyxNQUFMLENBQVksSUFBQyxDQUFBLElBQWIsQ0FBaEI7UUFDTixRQUFBLEdBQVcsS0FBSyxDQUFDLGdCQUFOLENBQXVCLEdBQXZCO1FBQ1gsU0FBQSxHQUFZLE9BQUEsQ0FBUSxhQUFSO1FBQ1osTUFBQSxHQUFTLFFBQUEsWUFBb0IsU0FBcEIsSUFBa0MsUUFBUSxDQUFDLElBQVQsS0FBaUIsSUFBQyxDQUFBO1FBRTdELElBQUMsQ0FBQSxTQUFELENBQVcsTUFBWDtRQUNBLElBQTJCLE1BQTNCO21CQUFBLFFBQVEsQ0FBQyxTQUFULENBQW1CLElBQW5CLEVBQUE7O0lBUFU7Ozs7R0FyRVU7O0FBOEU1QixNQUFNLENBQUMsT0FBUCxHQUFpQiIsInNvdXJjZXNDb250ZW50IjpbIiMgMDAgICAgIDAwICAgMDAwMDAwMCAgIDAwMDAwMDAwMCAgIDAwMDAwMDAgICAwMDAwMDAwMCAgICAwMDAwMDAwICAwMDAgICAwMDAgIDAwMCAgICAgIDAwMCAgMDAwICAgMDAwICAwMDAwMDAwICAgIDAwMDAwMDAwICAwMDAwMDAwMCBcbiMgMDAwICAgMDAwICAwMDAgICAwMDAgICAgIDAwMCAgICAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgICAgICAgMDAwIDAwMCAgIDAwMCAgICAgIDAwMCAgMDAwMCAgMDAwICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDBcbiMgMDAwMDAwMDAwICAwMDAgICAwMDAgICAgIDAwMCAgICAgMDAwICAgMDAwICAwMDAwMDAwICAgIDAwMCAgICAgICAgIDAwMDAwICAgIDAwMCAgICAgIDAwMCAgMDAwIDAgMDAwICAwMDAgICAwMDAgIDAwMDAwMDAgICAwMDAwMDAwICBcbiMgMDAwIDAgMDAwICAwMDAgICAwMDAgICAgIDAwMCAgICAgMDAwICAgMDAwICAwMDAgICAwMDAgIDAwMCAgICAgICAgICAwMDAgICAgIDAwMCAgICAgIDAwMCAgMDAwICAwMDAwICAwMDAgICAwMDAgIDAwMCAgICAgICAwMDAgICAwMDBcbiMgMDAwICAgMDAwICAgMDAwMDAwMCAgICAgIDAwMCAgICAgIDAwMDAwMDAgICAwMDAgICAwMDAgICAwMDAwMDAwICAgICAwMDAgICAgIDAwMDAwMDAgIDAwMCAgMDAwICAgMDAwICAwMDAwMDAwICAgIDAwMDAwMDAwICAwMDAgICAwMDBcblxueyBrbG9nIH0gPSByZXF1aXJlICdreGsnXG5JdGVtICAgICAgPSByZXF1aXJlICcuL2l0ZW0nXG5BY3Rpb24gICAgPSByZXF1aXJlICcuL2FjdGlvbidcbkZhY2UgICAgICA9IHJlcXVpcmUgJy4vZmFjZSdcbkdlb20gICAgICA9IHJlcXVpcmUgJy4vZ2VvbSdcblB1c2hhYmxlICA9IHJlcXVpcmUgJy4vcHVzaGFibGUnXG5NYXRlcmlhbCAgPSByZXF1aXJlICcuL21hdGVyaWFsJ1xuXG5jbGFzcyBNb3RvckN5bGluZGVyIGV4dGVuZHMgUHVzaGFibGUgI0l0ZW1cbiAgICBcbiAgICBpc1NwYWNlRWdvaXN0aWM6IC0+IHRydWVcbiAgICBcbiAgICBAOiAoQGZhY2UpIC0+XG4gICAgICAgIHN1cGVyKCkgICBcbiAgICAgICAgQHZhbHVlID0gMC4wXG4gICAgICAgIEBhY3RpdmUgPSBmYWxzZVxuICAgICAgICBAb3JpZW50YXRpb24gPSBGYWNlLm9yaWVudGF0aW9uRm9yRmFjZSBAZmFjZVxuICAgICAgICBAYWRkQWN0aW9uIG5ldyBBY3Rpb24gQCwgQWN0aW9uLlRVQ0tFUiwgJ3R1Y2tlcicgNTAwIEFjdGlvbi5SRVBFQVRcbiAgICBcbiAgICBzZXRQb3NpdGlvbjogKHBvcykgLT5cbiAgICAgICAgc3VwZXIgcG9zXG4gICAgICAgIEB1cGRhdGVBY3RpdmUoKVxuICAgICAgICBcbiAgICBkZWw6IC0+XG4gICAgICAgIFxuICAgICAgICBAa29sYmVuLmdlb21ldHJ5LmRpc3Bvc2UoKVxuICAgICAgICBAbWVzaC5nZW9tZXRyeS5kaXNwb3NlKClcbiAgICAgICAgc3VwZXJcbiAgICAgICAgXG4gICAgY3JlYXRlTWVzaDogLT5cbiAgICAgICAgICAgICAgICAgICAgXG4gICAgICAgIEBtZXNoICAgPSBuZXcgVEhSRUUuTWVzaCBHZW9tLmN5bGluZGVyKCksIE1hdGVyaWFsLnBsYXRlXG4gICAgICAgIEBrb2xiZW4gPSBuZXcgVEhSRUUuTWVzaCBHZW9tLmtvbGJlbigpLCAgIE1hdGVyaWFsLmdlYXJcbiAgICAgICAgQG1lc2guYWRkIEBrb2xiZW5cbiAgICAgICAgQG1lc2gucmVjZWl2ZVNoYWRvdyA9IHRydWVcbiAgICAgICAgQG1lc2guY2FzdFNoYWRvdyA9IHRydWVcbiAgICBcbiAgICB1cGRhdGVNZXNoOiAtPiBcbiAgICAgICAgQGtvbGJlbi5wb3NpdGlvbi5zZXQgMCwgMCwgLTAuNSAqIE1hdGguc2luIEB2YWx1ZSBcbiAgICAgICAgQG1lc2gucXVhdGVybmlvbi5jb3B5IEZhY2Uub3JpZW50YXRpb24gQGZhY2VcbiAgICAgICAgICAgICAgICBcbiAgICBzZXRBY3RpdmU6IChhY3RpdmUpIC0+XG4gICAgICAgIGlmIEBhY3RpdmUgIT0gYWN0aXZlXG4gICAgICAgICAgICBAYWN0aXZlID0gYWN0aXZlXG4gICAgICAgICAgICBpZiBAYWN0aXZlXG4gICAgICAgICAgICAgICAgQHN0YXJ0VGltZWRBY3Rpb24gQGdldEFjdGlvbldpdGhJZCBBY3Rpb24uVFVDS0VSXG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgQHN0b3BBY3Rpb24gQGdldEFjdGlvbldpdGhJZCBBY3Rpb24uVFVDS0VSXG4gICAgXG4gICAgaW5pdEFjdGlvbjogKGFjdGlvbikgLT5cbiAgICAgICAgaWYgYWN0aW9uLmlkIGluIFtBY3Rpb24uUFVTSCwgQWN0aW9uLkZBTExdXG4gICAgICAgICAgICBAc2V0QWN0aXZlIGZhbHNlXG4gICAgICAgICAgICBwb3MgPSBAcG9zaXRpb24ubWludXMgRmFjZS5ub3JtYWwgQGZhY2VcbiAgICAgICAgICAgIG9jY3VwYW50ID0gd29ybGQuZ2V0T2NjdXBhbnRBdFBvcyBwb3MgXG4gICAgICAgICAgICBNb3RvckdlYXIgPSByZXF1aXJlICcuL21vdG9yZ2VhcidcbiAgICAgICAgICAgIGlzR2VhciA9IG9jY3VwYW50IGluc3RhbmNlb2YgTW90b3JHZWFyIGFuZCBvY2N1cGFudC5mYWNlID09IEBmYWNlXG4gICAgICAgICAgICBrbG9nIFwiaW5pdEFjdGlvbiBpc0dlYXIgI3tpc0dlYXJ9XCJcbiAgICAgICAgICAgIG9jY3VwYW50LnNldEFjdGl2ZSBmYWxzZSBpZiBpc0dlYXJcbiAgICAgICAgc3VwZXIgYWN0aW9uXG4gICAgICAgIFxuICAgIHBlcmZvcm1BY3Rpb246IChhY3Rpb24pIC0+XG4gICAgICAgIGlmIGFjdGlvbi5pZCA9PSBBY3Rpb24uVFVDS0VSXG4gICAgICAgICAgICByZWxUaW1lID0gYWN0aW9uLmdldFJlbGF0aXZlVGltZSgpXG4gICAgICAgICAgICBAdmFsdWUgPSBpZiByZWxUaW1lID4gMC41IHRoZW4gMS4wIC0gcmVsVGltZSBlbHNlIHJlbFRpbWVcbiAgICAgICAgICAgIEB2YWx1ZSAqPSAyXG4gICAgICAgICAgICBAdXBkYXRlTWVzaCgpXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgc3VwZXIgYWN0aW9uXG4gICAgXG4gICAgZmluaXNoQWN0aW9uOiAoYWN0aW9uKSAtPlxuICAgICAgICBpZiBhY3Rpb24uaWQgPT0gQWN0aW9uLlRVQ0tFUlxuICAgICAgICAgICAgd29ybGQucGxheVNvdW5kICdNT1RPUicgQGdldFBvcygpXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgc3VwZXIgYWN0aW9uXG4gICAgICAgIGlmIGFjdGlvbi5pZCBpbiBbQWN0aW9uLlBVU0gsIEFjdGlvbi5GQUxMXVxuICAgICAgICAgICAgQHVwZGF0ZUFjdGl2ZSgpXG4gICAgXG4gICAgdXBkYXRlQWN0aXZlOiAtPlxuICAgICAgICBwb3MgPSBAcG9zaXRpb24ubWludXMgRmFjZS5ub3JtYWwgQGZhY2VcbiAgICAgICAgb2NjdXBhbnQgPSB3b3JsZC5nZXRPY2N1cGFudEF0UG9zIHBvcyBcbiAgICAgICAgTW90b3JHZWFyID0gcmVxdWlyZSAnLi9tb3RvcmdlYXInXG4gICAgICAgIGlzR2VhciA9IG9jY3VwYW50IGluc3RhbmNlb2YgTW90b3JHZWFyIGFuZCBvY2N1cGFudC5mYWNlID09IEBmYWNlXG4gICAgICAgICMga2xvZyBcImlzR2VhciAje2lzR2Vhcn1cIlxuICAgICAgICBAc2V0QWN0aXZlIGlzR2VhclxuICAgICAgICBvY2N1cGFudC5zZXRBY3RpdmUgdHJ1ZSBpZiBpc0dlYXJcbiAgICAgICAgXG5tb2R1bGUuZXhwb3J0cyA9IE1vdG9yQ3lsaW5kZXJcbiJdfQ==
//# sourceURL=../coffee/motorcylinder.coffee