// koffee 1.4.0
var Action, Face, Geom, Item, Material, MotorCylinder, Pushable, klog,
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty;

klog = require('kxk').klog;

Item = require('./item');

Action = require('./action');

Face = require('./face');

Geom = require('./geom');

Pushable = require('./pushable');

Material = require('./material');

MotorCylinder = (function(superClass) {
    extend(MotorCylinder, superClass);

    MotorCylinder.prototype.isSpaceEgoistic = function() {
        return true;
    };

    function MotorCylinder(face) {
        this.face = face;
        MotorCylinder.__super__.constructor.call(this);
        this.value = 0.0;
        this.active = false;
        this.orientation = Face.orientationForFace(this.face);
        this.addAction(new Action(this, Action.TUCKER, "tucker", 500, Action.REPEAT));
    }

    MotorCylinder.prototype.setPosition = function(pos) {
        MotorCylinder.__super__.setPosition.call(this, pos);
        return this.updateActive();
    };

    MotorCylinder.prototype.createMesh = function() {
        this.mesh = new THREE.Mesh(Geom.cylinder(), Material.plate);
        this.kolben = new THREE.Mesh(Geom.kolben(), Material.gear);
        this.mesh.add(this.kolben);
        this.mesh.receiveShadow = true;
        return this.mesh.castShadow = true;
    };

    MotorCylinder.prototype.updateMesh = function() {
        this.kolben.position.set(0, 0, -0.5 * Math.sin(this.value));
        return this.mesh.quaternion.copy(Face.orientation(this.face));
    };

    MotorCylinder.prototype.setActive = function(active) {
        if (this.active !== active) {
            this.active = active;
            if (this.active) {
                return this.startTimedAction(this.getActionWithId(Action.TUCKER));
            } else {
                return this.stopAction(this.getActionWithId(Action.TUCKER));
            }
        }
    };

    MotorCylinder.prototype.initAction = function(action) {
        var MotorGear, isGear, occupant, pos, ref;
        if ((ref = action.id) === Action.PUSH || ref === Action.FALL) {
            this.setActive(false);
            pos = this.position.minus(Face.normal(this.face));
            occupant = world.getOccupantAtPos(pos);
            MotorGear = require('./motorgear');
            isGear = occupant instanceof MotorGear && occupant.face === this.face;
            klog("initAction isGear " + isGear);
            if (isGear) {
                occupant.setActive(false);
            }
        }
        return MotorCylinder.__super__.initAction.call(this, action);
    };

    MotorCylinder.prototype.performAction = function(action) {
        var relTime;
        if (action.id === Action.TUCKER) {
            relTime = action.getRelativeTime();
            this.value = relTime > 0.5 ? 1.0 - relTime : relTime;
            this.value *= 2;
            this.updateMesh();
            return;
        }
        return MotorCylinder.__super__.performAction.call(this, action);
    };

    MotorCylinder.prototype.finishAction = function(action) {
        var ref;
        if (action.id === Action.TUCKER) {
            world.playSound('MOTOR', this.getPos());
            return;
        }
        MotorCylinder.__super__.finishAction.call(this, action);
        if ((ref = action.id) === Action.PUSH || ref === Action.FALL) {
            return this.updateActive();
        }
    };

    MotorCylinder.prototype.updateActive = function() {
        var MotorGear, isGear, occupant, pos;
        pos = this.position.minus(Face.normal(this.face));
        occupant = world.getOccupantAtPos(pos);
        MotorGear = require('./motorgear');
        isGear = occupant instanceof MotorGear && occupant.face === this.face;
        this.setActive(isGear);
        if (isGear) {
            return occupant.setActive(true);
        }
    };

    return MotorCylinder;

})(Pushable);

module.exports = MotorCylinder;

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW90b3JjeWxpbmRlci5qcyIsInNvdXJjZVJvb3QiOiIuIiwic291cmNlcyI6WyIiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQU1BLElBQUEsaUVBQUE7SUFBQTs7O0FBQUUsT0FBUyxPQUFBLENBQVEsS0FBUjs7QUFDWCxJQUFBLEdBQVksT0FBQSxDQUFRLFFBQVI7O0FBQ1osTUFBQSxHQUFZLE9BQUEsQ0FBUSxVQUFSOztBQUNaLElBQUEsR0FBWSxPQUFBLENBQVEsUUFBUjs7QUFDWixJQUFBLEdBQVksT0FBQSxDQUFRLFFBQVI7O0FBQ1osUUFBQSxHQUFZLE9BQUEsQ0FBUSxZQUFSOztBQUNaLFFBQUEsR0FBWSxPQUFBLENBQVEsWUFBUjs7QUFFTjs7OzRCQUVGLGVBQUEsR0FBaUIsU0FBQTtlQUFHO0lBQUg7O0lBRUosdUJBQUMsSUFBRDtRQUFDLElBQUMsQ0FBQSxPQUFEO1FBQ1YsNkNBQUE7UUFDQSxJQUFDLENBQUEsS0FBRCxHQUFTO1FBQ1QsSUFBQyxDQUFBLE1BQUQsR0FBVTtRQUNWLElBQUMsQ0FBQSxXQUFELEdBQWUsSUFBSSxDQUFDLGtCQUFMLENBQXdCLElBQUMsQ0FBQSxJQUF6QjtRQUNmLElBQUMsQ0FBQSxTQUFELENBQVcsSUFBSSxNQUFKLENBQVcsSUFBWCxFQUFjLE1BQU0sQ0FBQyxNQUFyQixFQUE2QixRQUE3QixFQUF1QyxHQUF2QyxFQUE0QyxNQUFNLENBQUMsTUFBbkQsQ0FBWDtJQUxTOzs0QkFPYixXQUFBLEdBQWEsU0FBQyxHQUFEO1FBQ1QsK0NBQU0sR0FBTjtlQUNBLElBQUMsQ0FBQSxZQUFELENBQUE7SUFGUzs7NEJBSWIsVUFBQSxHQUFZLFNBQUE7UUFFUixJQUFDLENBQUEsSUFBRCxHQUFVLElBQUksS0FBSyxDQUFDLElBQVYsQ0FBZSxJQUFJLENBQUMsUUFBTCxDQUFBLENBQWYsRUFBZ0MsUUFBUSxDQUFDLEtBQXpDO1FBQ1YsSUFBQyxDQUFBLE1BQUQsR0FBVSxJQUFJLEtBQUssQ0FBQyxJQUFWLENBQWUsSUFBSSxD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QSxRQUFRLENBQUMsS0FBVixDQUFnQixJQUFJLENBQUMsTUFBTCxDQUFZLElBQUMsQ0FBQSxJQUFiLENBQWhCO1FBQ04sUUFBQSxHQUFXLEtBQUssQ0FBQyxnQkFBTixDQUF1QixHQUF2QjtRQUNYLFNBQUEsR0FBWSxPQUFBLENBQVEsYUFBUjtRQUNaLE1BQUEsR0FBUyxRQUFBLFlBQW9CLFNBQXBCLElBQWtDLFFBQVEsQ0FBQyxJQUFULEtBQWlCLElBQUMsQ0FBQTtRQUU3RCxJQUFDLENBQUEsU0FBRCxDQUFXLE1BQVg7UUFDQSxJQUEyQixNQUEzQjttQkFBQSxRQUFRLENBQUMsU0FBVCxDQUFtQixJQUFuQixFQUFBOztJQVBVOzs7O0dBL0RVOztBQXdFNUIsTUFBTSxDQUFDLE9BQVAsR0FBaUIiLCJzb3VyY2VzQ29udGVudCI6WyIjIDAwICAgICAwMCAgIDAwMDAwMDAgICAwMDAwMDAwMDAgICAwMDAwMDAwICAgMDAwMDAwMDAgICAgMDAwMDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMCAgICAwMDAwMDAwMCAgMDAwMDAwMDAgXG4jIDAwMCAgIDAwMCAgMDAwICAgMDAwICAgICAwMDAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgIDAwMCAwMDAgICAwMDAgICAgICAwMDAgIDAwMDAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwXG4jIDAwMDAwMDAwMCAgMDAwICAgMDAwICAgICAwMDAgICAgIDAwMCAgIDAwMCAgMDAwMDAwMCAgICAwMDAgICAgICAgICAwMDAwMCAgICAwMDAgICAgICAwMDAgIDAwMCAwIDAwMCAgMDAwICAgMDAwICAwMDAwMDAwICAgMDAwMDAwMCAgXG4jIDAwMCAwIDAwMCAgMDAwICAgMDAwICAgICAwMDAgICAgIDAwMCAgIDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgICAgMDAwICAgICAwMDAgICAgICAwMDAgIDAwMCAgMDAwMCAgMDAwICAgMDAwICAwMDAgICAgICAgMDAwICAgMDAwXG4jIDAwMCAgIDAwMCAgIDAwMDAwMDAgICAgICAwMDAgICAgICAwMDAwMDAwICAgMDAwICAgMDAwICAgMDAwMDAwMCAgICAgMDAwICAgICAwMDAwMDAwICAwMDAgIDAwMCAgIDAwMCAgMDAwMDAwMCAgICAwMDAwMDAwMCAgMDAwICAgMDAwXG5cbnsga2xvZyB9ID0gcmVxdWlyZSAna3hrJ1xuSXRlbSAgICAgID0gcmVxdWlyZSAnLi9pdGVtJ1xuQWN0aW9uICAgID0gcmVxdWlyZSAnLi9hY3Rpb24nXG5GYWNlICAgICAgPSByZXF1aXJlICcuL2ZhY2UnXG5HZW9tICAgICAgPSByZXF1aXJlICcuL2dlb20nXG5QdXNoYWJsZSAgPSByZXF1aXJlICcuL3B1c2hhYmxlJ1xuTWF0ZXJpYWwgID0gcmVxdWlyZSAnLi9tYXRlcmlhbCdcblxuY2xhc3MgTW90b3JDeWxpbmRlciBleHRlbmRzIFB1c2hhYmxlICNJdGVtXG4gICAgXG4gICAgaXNTcGFjZUVnb2lzdGljOiAtPiB0cnVlXG4gICAgXG4gICAgY29uc3RydWN0b3I6IChAZmFjZSkgLT5cbiAgICAgICAgc3VwZXIoKSAgIFxuICAgICAgICBAdmFsdWUgPSAwLjBcbiAgICAgICAgQGFjdGl2ZSA9IGZhbHNlXG4gICAgICAgIEBvcmllbnRhdGlvbiA9IEZhY2Uub3JpZW50YXRpb25Gb3JGYWNlIEBmYWNlXG4gICAgICAgIEBhZGRBY3Rpb24gbmV3IEFjdGlvbiBALCBBY3Rpb24uVFVDS0VSLCBcInR1Y2tlclwiLCA1MDAsIEFjdGlvbi5SRVBFQVRcbiAgICBcbiAgICBzZXRQb3NpdGlvbjogKHBvcykgLT5cbiAgICAgICAgc3VwZXIgcG9zXG4gICAgICAgIEB1cGRhdGVBY3RpdmUoKVxuICAgICAgICBcbiAgICBjcmVhdGVNZXNoOiAtPlxuICAgICAgICAgICAgICAgICAgICBcbiAgICAgICAgQG1lc2ggICA9IG5ldyBUSFJFRS5NZXNoIEdlb20uY3lsaW5kZXIoKSwgTWF0ZXJpYWwucGxhdGVcbiAgICAgICAgQGtvbGJlbiA9IG5ldyBUSFJFRS5NZXNoIEdlb20ua29sYmVuKCksICAgTWF0ZXJpYWwuZ2VhclxuICAgICAgICBAbWVzaC5hZGQgQGtvbGJlblxuICAgICAgICBAbWVzaC5yZWNlaXZlU2hhZG93ID0gdHJ1ZVxuICAgICAgICBAbWVzaC5jYXN0U2hhZG93ID0gdHJ1ZVxuICAgIFxuICAgIHVwZGF0ZU1lc2g6IC0+IFxuICAgICAgICBAa29sYmVuLnBvc2l0aW9uLnNldCAwLCAwLCAtMC41ICogTWF0aC5zaW4gQHZhbHVlIFxuICAgICAgICBAbWVzaC5xdWF0ZXJuaW9uLmNvcHkgRmFjZS5vcmllbnRhdGlvbiBAZmFjZVxuICAgICAgICAgICAgICAgIFxuICAgIHNldEFjdGl2ZTogKGFjdGl2ZSkgLT5cbiAgICAgICAgaWYgQGFjdGl2ZSAhPSBhY3RpdmVcbiAgICAgICAgICAgIEBhY3RpdmUgPSBhY3RpdmVcbiAgICAgICAgICAgIGlmIEBhY3RpdmVcbiAgICAgICAgICAgICAgICBAc3RhcnRUaW1lZEFjdGlvbiBAZ2V0QWN0aW9uV2l0aElkIEFjdGlvbi5UVUNLRVJcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICBAc3RvcEFjdGlvbiBAZ2V0QWN0aW9uV2l0aElkIEFjdGlvbi5UVUNLRVJcbiAgICBcbiAgICBpbml0QWN0aW9uOiAoYWN0aW9uKSAtPlxuICAgICAgICBpZiBhY3Rpb24uaWQgaW4gW0FjdGlvbi5QVVNILCBBY3Rpb24uRkFMTF1cbiAgICAgICAgICAgIEBzZXRBY3RpdmUgZmFsc2VcbiAgICAgICAgICAgIHBvcyA9IEBwb3NpdGlvbi5taW51cyBGYWNlLm5vcm1hbCBAZmFjZVxuICAgICAgICAgICAgb2NjdXBhbnQgPSB3b3JsZC5nZXRPY2N1cGFudEF0UG9zIHBvcyBcbiAgICAgICAgICAgIE1vdG9yR2VhciA9IHJlcXVpcmUgJy4vbW90b3JnZWFyJ1xuICAgICAgICAgICAgaXNHZWFyID0gb2NjdXBhbnQgaW5zdGFuY2VvZiBNb3RvckdlYXIgYW5kIG9jY3VwYW50LmZhY2UgPT0gQGZhY2VcbiAgICAgICAgICAgIGtsb2cgXCJpbml0QWN0aW9uIGlzR2VhciAje2lzR2Vhcn1cIlxuICAgICAgICAgICAgb2NjdXBhbnQuc2V0QWN0aXZlIGZhbHNlIGlmIGlzR2VhclxuICAgICAgICBzdXBlciBhY3Rpb25cbiAgICAgICAgXG4gICAgcGVyZm9ybUFjdGlvbjogKGFjdGlvbikgLT5cbiAgICAgICAgaWYgYWN0aW9uLmlkID09IEFjdGlvbi5UVUNLRVJcbiAgICAgICAgICAgIHJlbFRpbWUgPSBhY3Rpb24uZ2V0UmVsYXRpdmVUaW1lKClcbiAgICAgICAgICAgIEB2YWx1ZSA9IGlmIHJlbFRpbWUgPiAwLjUgdGhlbiAxLjAgLSByZWxUaW1lIGVsc2UgcmVsVGltZVxuICAgICAgICAgICAgQHZhbHVlICo9IDJcbiAgICAgICAgICAgIEB1cGRhdGVNZXNoKClcbiAgICAgICAgICAgIHJldHVyblxuICAgICAgICBzdXBlciBhY3Rpb25cbiAgICBcbiAgICBmaW5pc2hBY3Rpb246IChhY3Rpb24pIC0+XG4gICAgICAgIGlmIGFjdGlvbi5pZCA9PSBBY3Rpb24uVFVDS0VSXG4gICAgICAgICAgICB3b3JsZC5wbGF5U291bmQgJ01PVE9SJywgQGdldFBvcygpXG4gICAgICAgICAgICByZXR1cm5cbiAgICAgICAgc3VwZXIgYWN0aW9uXG4gICAgICAgIGlmIGFjdGlvbi5pZCBpbiBbQWN0aW9uLlBVU0gsIEFjdGlvbi5GQUxMXVxuICAgICAgICAgICAgQHVwZGF0ZUFjdGl2ZSgpXG4gICAgXG4gICAgdXBkYXRlQWN0aXZlOiAtPlxuICAgICAgICBwb3MgPSBAcG9zaXRpb24ubWludXMgRmFjZS5ub3JtYWwgQGZhY2VcbiAgICAgICAgb2NjdXBhbnQgPSB3b3JsZC5nZXRPY2N1cGFudEF0UG9zIHBvcyBcbiAgICAgICAgTW90b3JHZWFyID0gcmVxdWlyZSAnLi9tb3RvcmdlYXInXG4gICAgICAgIGlzR2VhciA9IG9jY3VwYW50IGluc3RhbmNlb2YgTW90b3JHZWFyIGFuZCBvY2N1cGFudC5mYWNlID09IEBmYWNlXG4gICAgICAgICMgbG9nIFwiaXNHZWFyICN7aXNHZWFyfVwiXG4gICAgICAgIEBzZXRBY3RpdmUgaXNHZWFyXG4gICAgICAgIG9jY3VwYW50LnNldEFjdGl2ZSB0cnVlIGlmIGlzR2VhclxuICAgICAgICBcbm1vZHVsZS5leHBvcnRzID0gTW90b3JDeWxpbmRlclxuIl19
//# sourceURL=../coffee/motorcylinder.coffee